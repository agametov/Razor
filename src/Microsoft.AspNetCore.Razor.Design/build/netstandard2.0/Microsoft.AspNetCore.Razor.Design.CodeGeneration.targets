<Project>
  <!--
    Targets used for Razor SDK code generation. Support for the RazorCoreGenerate target.
    This target is explicitly imported by Razor SDK.
  -->

  <!-- 
    Consider these properties to be private to this targets file. The main Razor SDK should define all of the properties
    that we use to pass data back and forth. 
  -->
  <PropertyGroup>
    <!-- Used for tag helper discovery -->
    <_RazorTagHelperInputCache>$(IntermediateOutputPath)$(TargetName).TagHelpers.input.cache</_RazorTagHelperInputCache>
    <_RazorTagHelperOutputCache>$(IntermediateOutputPath)$(TargetName).TagHelpers.output.cache</_RazorTagHelperOutputCache>
    
    <!-- Used to locate our tools -->
    <_RazorToolAssembly>$(_RazorMSBuildRoot)tools\rzc.dll</_RazorToolAssembly>

    <!-- Used to hash file inputs for RazorGenerate -->
    <_RazorGenerateInputsHash></_RazorGenerateInputsHash>
    <_RazorGenerateInputsHashFile>$(IntermediateOutputPath)$(MSBuildProjectName).RazorCoreGenerate.cache</_RazorGenerateInputsHashFile>
  </PropertyGroup>

  <PropertyGroup>
    <RazorCoreGenerateDependsOn>
      $(RazorCoreGenerateDependsOn);
      _HashRazorGenerateInputs;
      _ResolveRazorGenerateOutputs;
      _RazorGeneratePass1;
      _PrepareForRazorTempCompile;
      RazorTempCompile;
      _RazorGenerateResolveTagHelpers;
      _RazorGeneratePass2
    </RazorCoreGenerateDependsOn>
  </PropertyGroup>

  <!--
    This target will only be called when we have some .cshtml files that are going to participate in code generation.

    This is part of the chain of targets that are called once we've actually committed to generating code.
  -->
  <Target 
    Name="_HashRazorGenerateInputs" 
    Condition="'@(RazorGenerate)'!=''">

    <Hash ItemsToHash="@(RazorGenerate)">
      <Output TaskParameter="HashResult" PropertyName="_RazorGenerateInputsHash" />
    </Hash>

    <MakeDir
      Directories="$(IntermediateOutputPath)"
      Condition="!Exists('$(IntermediateOutputPath)')" />

    <WriteLinesToFile
      Lines="$(_RazorGenerateInputsHash)"
      File="$(_RazorGenerateInputsHashFile)"
      Overwrite="True"
      WriteOnlyWhenDifferent="True" />

    <ItemGroup>
      <FileWrites Include="$(_RazorGenerateInputsHashFile)" />
    </ItemGroup>
  </Target>

  <Target Name="_ResolveRazorGenerateOutputs">
    <ItemGroup>
      <RazorGenerate Update="@(RazorGenerate)" Condtion="'%(RazorGenerate.GeneratedOutputPass1)'==''">
        <GeneratedOutputPass1>$(RazorGenerateIntermediateOutputPath)%(RelativeDir)%(Filename).g.i.cs</GeneratedOutputPass1>
      </RazorGenerate>
      <RazorGenerate Update="@(RazorGenerate)" Condtion="'%(RazorGenerate.GeneratedOutputPass2)'==''">
        <GeneratedOutputPass2>$(RazorGenerateIntermediateOutputPath)%(RelativeDir)%(Filename).g.cs</GeneratedOutputPass2>
      </RazorGenerate>
    </ItemGroup>

    <ItemGroup>
      <_RazorGenerateInputPass1 Include="%(RazorGenerate.Identity)" Condition="'%(RazorGenerate.GeneratedOutputPass1)'!=''"/>
      <_RazorGenerateInputPass2 Include="%(RazorGenerate.Identity)" Condition="'%(RazorGenerate.GeneratedOutputPass2)'!=''"/>

      <_RazorGenerateOutputPass1 Include="%(RazorGenerate.GeneratedOutputPass1)" Condition="'%(RazorGenerate.GeneratedOutputPass1)'!=''"/>    
      <_RazorGenerateOutputPass2 Include="%(RazorGenerate.GeneratedOutputPass2)" Condition="'%(RazorGenerate.GeneratedOutputPass2)'!=''"/>  
    </ItemGroup>
  </Target>

  <Target
    Name="_RazorGeneratePass1"
    Inputs="$(MSBuildAllProjects);$(_RazorGenerateInputsHashFile);@(_RazorGenerateInputPass1)"
    Outputs="@(_RazorGenerateOutputPass1)"
    Condition="'@(_RazorGenerateInputPass1)'!= ''">

    <MakeDir
      Directories="%(_RazorGenerateOutputPass1.RelativeDir)"
      Condition="!Exists('%(_RazorGenerateOutputPass1.RelativeDir)')" />

    <RazorGeneratePass1
      Debug="$(_RazorDebugGenerateCodeTask)"
      DebugTool="$(_RazorDebugGenerateCodeTool)"
      ToolAssembly="$(_RazorToolAssembly)"
      UseServer="$(UseRazorBuildServer)"
      Sources="@(_RazorGenerateInputPass1)"
      OutputFiles="@(_RazorGenerateOutputPass1)"
      ProjectRoot="$(MSBuildProjectDirectory)" />

    <ItemGroup>
      <FileWrites Include="@(_RazorGenerateOutputPass1)" />
    </ItemGroup>
  </Target>

  <Target Name="_PrepareForRazorTempCompile">
    <ItemGroup>
      <RazorTempCompile Include="@(Compile)" />
      <RazorTempCompile Include="@(_RazorGenerateOutputPass1)" />
    </ItemGroup>
  </Target>

  <Target
    Name="_RazorGenerateResolveTagHelpers"
    Inputs="$(MSBuildAllProjects);@(RazorReferencePath)"
    Outputs="$(_RazorTagHelperInputCache)"
    Condition="'@(RazorGenerate)'!=''">

    <!-- 
      We're manipulating our output directly here because we want to separate the actual up-to-date check
      of RazorCoreGenerate from the output of this target. Many times the set of tag helpers doesn't change
      so we don't need to regenerate the code.
      -->
    <Touch
      Files="$(_RazorTagHelperInputCache)"
      AlwaysCreate="true">
      <Output
        TaskParameter="TouchedFiles"
        ItemName="FileWrites" />
    </Touch>

    <RazorTagHelper
      Debug="$(_RazorDebugTagHelperTask)"
      DebugTool="$(_RazorDebugTagHelperTool)"
      ToolAssembly="$(_RazorToolAssembly)"
      UseServer="$(UseRazorBuildServer)"
      Assemblies="@(RazorReferencePath)"
      ProjectRoot="$(MSBuildProjectDirectory)"
      TagHelperManifest="$(_RazorTagHelperOutputCache)">
      <Output
        TaskParameter="TagHelperManifest"
        ItemName="FileWrites"/>
    </RazorTagHelper>
  </Target>

  <Target
    Name="_RazorGeneratePass2"
    Inputs="$(MSBuildAllProjects);$(_RazorGenerateInputsHashFile);$(_RazorTagHelperOutputCache);@(_RazorGenerateInputPass2)"
    Outputs="@(_RazorGenerateOutputPass2)"
    Condition="'@(_RazorGenerateInputPass2)'!= ''">

    <MakeDir
      Directories="%(_RazorGenerateOutputPass2.RelativeDir)"
      Condition="!Exists('%(_RazorGenerateOutputPass2.RelativeDir)')" />

    <RazorGeneratePass2
      Debug="$(_RazorDebugGenerateCodeTask)"
      DebugTool="$(_RazorDebugGenerateCodeTool)"
      ToolAssembly="$(_RazorToolAssembly)"
      UseServer="$(UseRazorBuildServer)"
      Sources="@(_RazorGenerateInputPass2)"
      OutputFiles="@(_RazorGenerateOutputPass2)"
      ProjectRoot="$(MSBuildProjectDirectory)"
      TagHelperManifest="$(_RazorTagHelperOutputCache)" />

    <ItemGroup>
      <FileWrites Include="@(_RazorGenerateOutputPass2)" />
      <Compile Include="@(_RazorGenerateOutputPass2)" />
    </ItemGroup>
  </Target>

  <Target Name="RazorCoreGenerate" DependsOnTargets="$(RazorCoreGenerateDependsOn)">
  </Target>

  <PropertyGroup>
    <ResolveRazorCompileInputsDependsOn>
      $(ResolveRazorCompileInputsDependsOn);
      _ResolveGeneratedRazorCompileInputs
    </ResolveRazorCompileInputsDependsOn>
  </PropertyGroup>

  <Target Name="_ResolveGeneratedRazorCompileInputs">
    <ItemGroup>
      <RazorCompile Include="@(_RazorGenerateOutput)" />
      <RazorEmbeddedResource Include="@(RazorGenerate)" Condition="$(EmbedRazorGenerateSources)">
        <LogicalName>/$([System.String]::Copy('%(Identity)').Replace('\','/'))</LogicalName>
        <Type>Non-Resx</Type>
        <WithCulture>false</WithCulture>
      </RazorEmbeddedResource>
    </ItemGroup>

    <!-- Similar to _GenerateCompileInputs -->
    <ItemGroup>
      <_RazorCoreCompileResourceInputs 
        Include="@(RazorEmbeddedResource)" 
        Condition="'%(RazorEmbeddedResource.WithCulture)'=='false' and '%(RazorEmbeddedResource.Type)'=='Non-Resx' " />
    </ItemGroup>
  </Target>

</Project>
